name: Deploy to VPS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 7979
          script: |
            set -euxo pipefail
            echo "== whoami/id =="
            whoami
            id
            echo "== sudo -n -l =="
            sudo -n -l || true
            echo "== check sudoers files =="
            sudo -n ls -la /etc/sudoers.d || true
            sudo -n cat /etc/sudoers.d/noesis-ci || true
            sudo -n cat /etc/sudoers.d/noesis-update || true
            echo "== run update =="
            /usr/local/bin/noesis-update
